<!DOCTYPE html>
<html>
<head>
    <title>CSV处理工具</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1 style="text-align: center;">Amazon评论分析</h1>
        <h3>上传CSV文件</h3>
        <p style="color:red">注意：词带（-）负号意思是否定, 查看<a target="_blank" href="https://juejin.cn/post/7503799944064778240">使用教程</a></p>
        <input type="file" id="csvFile" accept=".csv">
        <button onclick="uploadFile()">上传处理</button>
        <p>上传文件格式demo: <a href="{{ url_for('static', filename='demo.csv') }}">下载</a></p>
        <div id="loading" class="hidden">处理中，请稍候...</div>
        <div id="downloadSection" class="hidden">
            <a id="downloadLink" download="processed.csv">下载处理后的文件</a>
        </div>
        <div id="show_result">
            <h2>处理结果</h2>
            <div id="wordFrequencyResults">
                <h3>词频分析结果</h3>
                <div id="result"></div>
                <div id="wordCloud"></div>
            </div>
        </div>
       
    </div>
    <!-- 引入 ECharts -->
    <script src="{{ url_for('static', filename='echarts.min.js') }}"></script>
    <script>
    function uploadFile() {
        const chartIds = [];
        console.log('开始上传文件处理流程');
        const file = document.getElementById('csvFile').files[0];
        if(!file) {
            alert('请先选择CSV文件');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);

        // 显示加载提示
        console.log('显示加载提示');
        document.getElementById('loading').classList.remove('hidden');

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // 隐藏加载提示
            document.getElementById('loading').classList.add('hidden');
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = data.filepath;
            document.getElementById('downloadSection').classList.remove('hidden');
            
            // 显示词频分析结果
            if(data.wordFrequency) {
                let resultHTML = '';
                // 由于后续代码中不能重复声明 chartIds，这里先声明变量，避免重复声明问题
// 移除重复声明，使用已存在的 chartIds 变量，无需重新声明
// 这里不做任何声明操作，因为后续代码会复用这个变量
                for(const [category, words] of Object.entries(data.wordFrequency)) {
                    // 过滤空分类
                    if(Object.keys(words).length === 0) continue;
                    const chineseCategory = decodeURIComponent(JSON.parse('"' + category + '"'));
                    resultHTML += `<h4>${chineseCategory}</h4><ul>`;
                    for(const [word, count] of Object.entries(words)) {
                        resultHTML += `<li>${word}: ${count}</li>`;
                    }
                    resultHTML += '</ul>';
                    
                    // 为每个分类创建ECharts图表并记录ID
                    const chartId = 'chart_' + category + '_' + Date.now();
                    console.log('创建图表容器:', chartId);
                    resultHTML += `<div id="${chartId}" style="width:100%;height:400px;"></div>`;
                    chartIds.push(chartId);
                }
                document.getElementById('result').innerHTML = resultHTML;
                
                
                
                // 初始化所有图表
                // 二次过滤确保有效分类
                const validChartIds = chartIds.filter((id, index) => {
                    const category = Object.keys(data.wordFrequency)[index];
                    return Object.keys(data.wordFrequency[category]).length > 0;
                });
                
                for(let i = 0; i < validChartIds.length; i++) {
                    const chartDom = document.getElementById(chartIds[i]);
                    if(chartDom) {
                        console.log('初始化图表:', chartIds[i]);
                        const myChart = echarts.init(chartDom);
                        console.log('图表初始化完成:', myChart);
                        const category = Object.keys(data.wordFrequency)[i];
                        const words = data.wordFrequency[category];
                        console.log('准备渲染图表数据:', {category, words});
                    
                        // 准备图表数据
                        const chartWords = Object.entries(words)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10);
                    
                        const option = {
                            title: {
                                text: `${category} - 词频Top10`
                            },
                            tooltip: {},
                            xAxis: {
                                type: 'value'
                            },
                            yAxis: {
                                type: 'category',
                                data: chartWords.map(item => item[0])
                            },
                            series: [{
                                name: '出现次数',
                                type: 'bar',
                                data: chartWords.map(item => item[1])
                            }]
                        };
                    
                        console.log('设置图表选项:', option);
                        myChart.setOption(option);
                        console.log('图表渲染完成');
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('上传处理失败: ' + error.message);
            // 隐藏加载提示
            document.getElementById('loading').classList.add('hidden');
        });
    }
    </script>
</body>
</html>